version: "3"

services:
  common: &common
    image: foundationdb-build:0.0.1
    build:
      context: .
      dockerfile: Dockerfile

  build-setup: &build-setup
    <<: *common
    depends_on: [common]
    volumes:
      - ..:/foundationdb
    working_dir: /foundationdb

  build-docs:
    <<: *build-setup
    environment:
      - RELEASE=false
    command: /bin/bash -cl 'make clean && make docpackage'

  build-release: &build-release
    <<: *build-setup
    environment:
      - RELEASE=true
    command: /bin/bash -cl 'make clean && make packages'

  build-snapshot: &build-snapshot
    <<: *build-setup
    environment:
      - RELEASE=false
    command: /bin/bash -cl 'make clean && make packages'

  build-prb:
    <<: *build-snapshot

  shell:
    <<: *build-setup
    volumes:
      - ..:/foundationdb
      - ~/.m2:/root/.m2
    entrypoint: /bin/bash
